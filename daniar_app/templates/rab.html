<!-- FILE: templates/rab.html -->
{% extends "base.html" %}

{% block title %}Daftar RAB - PT. Daniar Furniture Art{% endblock %}

{% block extra_css %}
<style>
    /* --- Tema Warna Oranye Dominan --- */
    :root {
        --primary-orange: #f77f00;
        --dark-orange: #d35400;
        --light-orange: #fdebd0;
        --dark-bg: #2c3e50;
        --light-bg: #f8f9fc;
        --white: #ffffff;
        --success-green: #00b894;
        --warning-orange: #f77f00;
        --info-blue: #3498db;
    }

    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .card-header {
        background-color: var(--white);
        border-bottom: 1px solid #e9ecef;
        border-radius: 16px 16px 0 0 !important;
        font-weight: 700;
        color: var(--dark-bg);
        padding: 1.25rem 1.5rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-orange), var(--dark-orange));
        border: none;
        border-radius: 10px;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(247, 127, 0, 0.3);
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: var(--light-bg);
        border-bottom: 2px solid var(--primary-orange);
        font-weight: 700;
        color: var(--dark-bg);
        text-transform: uppercase;
        font-size: 0.85rem;
        padding: 1rem 0.75rem;
    }

    .table tbody td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        border-color: #e9ecef;
    }

    .table tbody tr:hover {
        background-color: var(--light-orange);
        transition: background-color 0.3s ease;
    }

    .badge-status {
        font-size: 0.75rem;
        padding: 0.4em 0.7em;
        border-radius: 8px;
        font-weight: 600;
    }

    .badge-draft {
        background-color: #95a5a6;
        color: white;
    }

    .badge-review {
        background-color: #f39c12;
        color: white;
    }

    .badge-approved {
        background-color: var(--success-green);
        color: white;
    }

    .badge-rejected {
        background-color: #e74c3c;
        color: white;
    }

    .money-format {
        font-family: 'Courier New', monospace;
        font-weight: 600;
        letter-spacing: -0.5px;
    }

    .project-code {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        color: var(--primary-orange);
        font-weight: 600;
    }

    .client-name {
        font-weight: 600;
        color: var(--dark-bg);
    }

    .project-desc {
        font-size: 0.85rem;
        color: #6c757d;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .action-buttons .btn {
        margin-right: 0.25rem;
        border-radius: 8px;
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }

    .btn-info {
        background: linear-gradient(135deg, #74b9ff, #0984e3);
        border: none;
    }

    .btn-warning {
        background: linear-gradient(135deg, #fdcb6e, #e17055);
        border: none;
        color: var(--dark-bg);
    }

    .btn-danger {
        background: linear-gradient(135deg, #e74c3c, #e84393);
        border: none;
    }

    .btn-pdf {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        border: none;
        color: white;
    }

    .btn-whatsapp {
        background: linear-gradient(135deg, #25D366, #128C7E);
        border: none;
        color: white;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Summary Cards */
    .summary-card {
        background: var(--white);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border-left: 4px solid;
        transition: all 0.3s ease;
    }

    .summary-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
    }

    .summary-card.total { border-left-color: var(--primary-orange); }
    .summary-card.draft { border-left-color: #95a5a6; }
    .summary-card.approved { border-left-color: var(--success-green); }
    .summary-card.pending { border-left-color: #f39c12; }

    /* Animasi */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in {
        animation: fadeInUp 0.6s ease-out forwards;
    }

    /* Action buttons group */
    .action-group {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
    }

    .action-group .btn {
        margin-right: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4 animate-fade-in">
        <h1 class="h3 mb-0" style="color: var(--dark-bg); font-weight: 700;">ðŸ“‹ Rencana Anggaran Biaya (RAB)</h1>
        <a href="{{ url_for('main.buat_rab') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Buat RAB Baru
        </a>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4 animate-fade-in" style="animation-delay: 0.1s;">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="summary-card total">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Total RAB</h6>
                        <h4 class="mb-0 text-dark">{{ rab|length }}</h4>
                    </div>
                    <i class="bi bi-folder text-primary fs-3"></i>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="summary-card draft">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Dalam Draft</h6>
                        <h4 class="mb-0 text-dark">
                            {% set draft_count = rab|selectattr('status', 'equalto', 'DRAFT')|list %}
                            {{ draft_count|length }}
                        </h4>
                    </div>
                    <i class="bi bi-pencil text-secondary fs-3"></i>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="summary-card approved">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Disetujui</h6>
                        <h4 class="mb-0 text-dark">
                            {% set approved_count = rab|selectattr('status', 'equalto', 'APPROVED')|list %}
                            {{ approved_count|length }}
                        </h4>
                    </div>
                    <i class="bi bi-check-circle text-success fs-3"></i>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="summary-card pending">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-muted mb-1">Menunggu Review</h6>
                        <h4 class="mb-0 text-dark">
                            {% set review_count = rab|selectattr('status', 'equalto', 'REVIEW')|list %}
                            {{ review_count|length }}
                        </h4>
                    </div>
                    <i class="bi bi-clock text-warning fs-3"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- RAB Table -->
    <div class="card shadow animate-fade-in" style="animation-delay: 0.2s;">
        <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary">Daftar Rencana Anggaran Biaya</h6>
        </div>
        <div class="card-body p-0">
            {% if rab %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th width="5%">No.</th>
                            <th width="12%">Kode RAB</th>
                            <th width="18%">Nama Proyek</th>
                            <th width="13%">Klien</th>
                            <th width="10%">Tanggal</th>
                            <th width="15%">Total Anggaran</th>
                            <th width="10%">Status</th>
                            <th width="17%">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rab %}
                        <tr>
                            <td class="fw-bold">{{ loop.index }}</td>
                            <td>
                                <span class="project-code">{{ r.kode_rab or 'RAB-' ~ r.id }}</span>
                            </td>
                            <td>
                                <div class="client-name">{{ r.nama_proyek }}</div>
                                <div class="project-desc" title="{{ r.deskripsi or '' }}">
                                    {{ r.deskripsi or 'Tidak ada deskripsi' }}
                                </div>
                            </td>
                            <td>
                                <div class="client-name">{{ r.nama_klien or '-' }}</div>
                                <small class="text-muted">{{ r.lokasi_proyek or '' }}</small>
                            </td>
                            <td>
                                <span class="fw-bold">{{ r.tanggal.strftime('%d %b %Y') }}</span>
                            </td>
                            <td>
                                <span class="money-format text-success fw-bold">{{ r.total_anggaran|currency }}</span>
                            </td>
                            <td>
                                {% if r.status == 'DRAFT' %}
                                    <span class="badge badge-status badge-draft">DRAFT</span>
                                {% elif r.status == 'REVIEW' %}
                                    <span class="badge badge-status badge-review">REVIEW</span>
                                {% elif r.status == 'APPROVED' %}
                                    <span class="badge badge-status badge-approved">APPROVED</span>
                                {% elif r.status == 'REJECTED' %}
                                    <span class="badge badge-status badge-rejected">REJECTED</span>
                                {% else %}
                                    <span class="badge badge-status badge-draft">DRAFT</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-group">
                                    <a href="{{ url_for('main.detail_rab', id=r.id) }}" class="btn btn-info btn-sm" title="Lihat Detail">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('main.edit_rab', id=r.id) }}" class="btn btn-warning btn-sm" title="Edit RAB">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{{ url_for('main.export_rab_pdf', rab_id=r.id) }}" class="btn btn-pdf btn-sm" title="Download PDF">
                                        <i class="bi bi-file-pdf"></i>
                                    </a>
                                    <a href="{{ url_for('main.print_rab', rab_id=r.id) }}" class="btn btn-secondary btn-sm" title="Print" target="_blank">
                                        <i class="bi bi-printer"></i>
                                    </a>
                                    <a href="{{ url_for('main.kirim_rab_whatsapp', rab_id=r.id) }}" class="btn btn-whatsapp btn-sm" title="Kirim WhatsApp">
                                        <i class="bi bi-whatsapp"></i>
                                    </a>
                                    <form action="{{ url_for('main.hapus_rab', id=r.id) }}" method="post" class="d-inline" onsubmit="return confirm('Hapus RAB ini?')">
                                        <button type="submit" class="btn btn-danger btn-sm" title="Hapus RAB">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state">
                <i class="bi bi-calculator"></i>
                <h4 class="text-muted">Belum Ada RAB</h4>
                <p class="text-muted">Mulai dengan membuat Rencana Anggaran Biaya pertama Anda.</p>
                <a href="{{ url_for('main.buat_rab') }}" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-circle"></i> Buat RAB Pertama
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    {% if rab %}
    <div class="row mt-4 animate-fade-in" style="animation-delay: 0.3s;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">Aksi Cepat</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-3 flex-wrap">
                        <a href="{{ url_for('main.buat_rab') }}" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle"></i> RAB Baru
                        </a>
                        <a href="#" class="btn btn-outline-success">
                            <i class="bi bi-download"></i> Export Excel
                        </a>
                        <a href="#" class="btn btn-outline-danger" onclick="exportAllRAB()">
                            <i class="bi bi-file-pdf"></i> Export Semua PDF
                        </a>
                        <a href="#" class="btn btn-outline-success" onclick="shareAllRAB()">
                            <i class="bi bi-whatsapp"></i> Share via WhatsApp
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tambahkan animasi hover pada card
    const cards = document.querySelectorAll('.card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // Konfirmasi hapus
    const deleteForms = document.querySelectorAll('form[onsubmit]');
    deleteForms.forEach(form => {
        form.onsubmit = function(e) {
            e.preventDefault();
            if (confirm('Apakah Anda yakin ingin menghapus RAB ini?')) {
                this.submit();
            }
        };
    });
});

// Fungsi untuk export semua RAB
function exportAllRAB() {
    if (confirm('Export semua RAB sebagai PDF? Ini mungkin memakan waktu beberapa saat.')) {
        // Implementasi export semua RAB
        const rabIds = {{ rab|map(attribute='id')|list|tojson }};
        if (rabIds.length > 0) {
            // Download PDF untuk RAB pertama sebagai contoh
            window.open("{{ url_for('main.export_rab_pdf', rab_id=0) }}".replace('/0', '/' + rabIds[0]), '_blank');
        }
        alert('Fitur export semua RAB sedang dalam pengembangan. Untuk saat ini, export per RAB tersedia.');
    }
}

// Fungsi untuk share via WhatsApp
function shareAllRAB() {
    if (confirm('Kirim summary RAB via WhatsApp?')) {
        const totalRAB = {{ rab|length }};
        const totalAnggaran = {{ rab|sum(attribute='total_anggaran') }};
        
        const message = `ðŸ“‹ *SUMMARY RAB - PT. Daniar Furniture Art*

ðŸ“Š Total RAB: ${totalRAB}
ðŸ’° Total Anggaran: Rp ${totalAnggaran.toLocaleString('id-ID')}

ðŸ“¥ Download detail masing-masing RAB melalui sistem.

_Generated by Daniar Furniture Art System_`;
        
        // Untuk sementara, tampilkan message yang bisa di-copy
        alert('Copy pesan berikut dan kirim via WhatsApp:\n\n' + message);
    }
}

// Copy WhatsApp message untuk RAB tertentu
function copyWhatsAppMessage(rabId, rabName) {
    const message = `ðŸ“‹ *RAB - ${rabName}*
    
Download PDF: {{ url_for('main.export_rab_pdf', rab_id=0, _external=True) }}`.replace('/0', '/' + rabId);
    
    navigator.clipboard.writeText(message).then(function() {
        alert('Pesan WhatsApp telah disalin ke clipboard!');
    }, function() {
        alert('Gagal menyalin pesan. Silakan copy manual.');
    });
}
</script>
{% endblock %}